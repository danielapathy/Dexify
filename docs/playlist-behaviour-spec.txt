# Playlist Behaviour Specification
# =================================
# Extracted from user requirements. This is the single source of truth for how
# playlists should behave across the entire app.


## 1. "Your Library" Sidebar — Playlist Row Lifecycle

### 1.1 When a playlist row APPEARS
- A playlist row appears under "Your Library" when at least one track belonging
  to that playlist exists on local disk (downloaded).

### 1.2 When a playlist row is REMOVED
- A playlist row is removed from "Your Library" ONLY when zero tracks belonging
  to that playlist remain on local disk.
- Deleting some (but not all) tracks from a playlist must NOT remove the row.

### 1.3 When a playlist row is BUMPED TO TOP
- Playing any track that belongs to a downloaded playlist bumps that playlist's
  row to the top of "Your Library" (most-recent behaviour).
- The bump is per-playlist, not per-track. Playing "LOONA - Star" from
  "My Boy" bumps "My Boy" to the top, not "LOONA" or the LOONA album.


## 2. Deletion Behaviour — All Methods

Every deletion method must actually delete the files from disk, not just hide
them from the UI. The following methods all exist and must behave consistently:

### 2.1 Single track delete (right-click → Delete)
- Deletes the track's audio file and track.json from the playlist's local
  folder structure.
- Updates the download library DB to reflect the track is no longer downloaded.
- If the playlist still has other downloaded tracks: playlist row stays in
  "Your Library", no other changes.
- If the playlist now has zero downloaded tracks: playlist row is removed from
  "Your Library".

### 2.2 Multi-select delete
- Same as 2.1, applied to each selected track.
- Playlist row removal check happens AFTER all selected tracks are deleted.

### 2.3 "Delete from library" (whole playlist/album delete)
- Deletes ALL downloaded tracks belonging to that playlist from disk.
- Removes the playlist folder structure entirely.
- Removes the playlist row from "Your Library".
- Must actually delete files, not just mark them as deleted in the DB.

### 2.4 Known bugs to fix
- Tracks that are "deleted" can still be played → files are not actually
  removed from disk, only hidden in the UI.
- Playing a "deleted" track causes a duplicate playlist row to appear under
  "Your Library".
- These are symptoms of the same root cause: deletion is cosmetic, not real.


## 3. Local File Structure for Playlists

Playlists are stored as self-contained units. Each playlist is its own folder
containing all the data needed to reconstruct it offline.

### 3.1 Directory layout

    <DownloadsDir>/
    └── <Playlist Name>/
        ├── playlist-cover.png
        ├── playlist.json          (playlist metadata: title, id, track list)
        │
        ├── <Album Name 1>/        (album that contains some of the playlist's tracks)
        │   ├── album.json         (album metadata)
        │   ├── cover.png          (album art)
        │   └── Tracks/
        │       ├── <Track Title>/
        │       │   ├── track.json (track metadata)
        │       │   └── track.mp3  (audio file)
        │       └── <Track Title>/
        │           ├── track.json
        │           └── track.mp3
        │
        └── <Album Name 2>/
            ├── album.json
            ├── cover.png
            └── Tracks/
                └── <Track Title>/
                    ├── track.json
                    └── track.mp3

### 3.2 Key rules
- Tracks are grouped by their REAL album within the playlist folder.
- Only downloaded tracks are present. If a playlist has 30 tracks but only 3
  are downloaded, only those 3 (and their parent album folders) exist on disk.
- Duplicates across playlists are allowed and expected. The same track can
  exist in multiple playlist folders independently.
- Album metadata (album.json, cover.png) is downloaded alongside the tracks
  so the playlist is fully self-contained.
- playlist.json contains the full track listing (including non-downloaded
  tracks) so the app knows what the playlist contains vs what is available
  offline.

### 3.3 Example

    My Boy/
    ├── playlist-cover.png
    ├── playlist.json
    ├── Scissor Sisters - Ta-Dah/
    │   ├── album.json
    │   ├── cover.png
    │   └── Tracks/
    │       ├── I Don't Feel Like Dancin'/
    │       │   ├── track.json
    │       │   └── track.mp3
    │       └── She's My Man/
    │           ├── track.json
    │           └── track.mp3
    └── LOONA - [12:00]/
        ├── album.json
        ├── cover.png
        └── Tracks/
            └── Star/
                ├── track.json
                └── track.mp3


## 4. Playback Context — Which Art Shows Where

When playing a track from a playlist, the track has TWO contexts:
its real album, and the playlist it was played from.

### 4.1 Inside the playlist view
- Each track row shows the track's REAL ALBUM ART next to the track name.
- This is the album the track actually belongs to (e.g., LOONA's album art
  next to "Star").

### 4.2 Bottom-left now-playing bar
- Shows the PLAYLIST cover art (not the album art).
- Because the user played it from the playlist context.

### 4.3 Home page "Recents" grid
- Shows the PLAYLIST cover art.
- The recent entry represents the playlist, not the individual track's album.
- Clicking it navigates to the playlist, not the album.

### 4.4 Bumping behaviour
- Playing a track from a playlist bumps the PLAYLIST to the top of recents
  and "Your Library", not the track's real album.


## 5. Download Behaviour

### 5.1 Downloading from within a playlist view
- Downloads are scoped to the playlist. The file lands inside the playlist's
  folder structure (see Section 3).
- The download library DB records both the track AND its parent playlist.
- A single track should NOT be downloaded as a standalone album download and
  then loosely linked to the playlist via DB. It must physically live inside
  the playlist folder.

### 5.2 Downloading an entire playlist
- Downloads all tracks, grouped by album, into the playlist folder.
- Album metadata is fetched and saved for each album represented in the
  playlist.

### 5.3 Partial downloads
- A playlist can be partially downloaded. Only the downloaded tracks (and
  their album folders) exist on disk.
- Non-downloaded tracks still appear in the playlist view (from playlist.json
  or the API) but are not playable offline.


## 6. Investigation Checklist

Before implementing fixes, the following code paths must be audited against
this spec:

  [ ] Library sidebar: row add/remove/bump logic
  [ ] Single track delete: does it actually delete files?
  [ ] Multi-select delete: does it actually delete files?
  [ ] "Delete from library" (whole playlist): does it actually delete files?
  [ ] After deletion: can "deleted" tracks still be played?
  [ ] After deletion: does playing a "deleted" track create duplicate rows?
  [ ] Download file layout: are tracks stored inside playlist folders?
  [ ] Download DB: does it record playlist association?
  [ ] Playback context: does now-playing show playlist art or album art?
  [ ] Recents: does it show playlist art and navigate to playlist?
  [ ] Bump-to-top: does playing from playlist bump the playlist (not album)?
  [ ] Partial download state: is it handled correctly in the UI?
