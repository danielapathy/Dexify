================================================================================
PLAYLIST SYSTEM — COMPREHENSIVE SPECIFICATION & BUG ANALYSIS
================================================================================
Generated from full codebase audit + user requirements extraction.
Cross-references: docs/playlist-behavior-spec.txt, docs/edge_case_investigation.js

TABLE OF CONTENTS
  §1  User Requirements (extracted & clarified)
  §2  Architecture Overview (two-layer data model)
  §3  Interaction Matrix (every action × expected outcome)
  §4  Identified Bugs (current state, root cause, user impact)
  §5  Bug Reproduction Flows (step-by-step)
  §6  Cross-Bug Dependency Map (how fixes interact)
  §7  Previous Patch Artifacts & Risks
  §8  File-Level Code Map (where each behavior lives)


================================================================================
§1  USER REQUIREMENTS (EXTRACTED & CLARIFIED)
================================================================================

The user's request contains several interlocking requirements. Below is the
distilled, unambiguous version of each.

1.1  ON-DISK FILE STRUCTURE FOR PLAYLISTS
-----------------------------------------
Tracks downloaded via a playlist MUST be stored in a playlist-scoped directory
tree, grouped by their parent album:

  library/playlists/{playlistId}/
    playlist.json            — playlist metadata (title, cover, track list)
    items.json               — { trackIds: [...], downloads: { trackId: { audioPath, quality } } }
    tracks/{trackId}/{quality}/
      audio.mp3|flac         — actual audio (hard-link or copy from album canonical)
      track.json             — track metadata

  library/albums/{albumId}/
    album.json               — album metadata
    cover.jpg                — album cover art
    tracks/{trackId}/{quality}/
      audio.mp3|flac         — canonical audio file
      track.json             — track metadata

KEY PRINCIPLE: Playlist tracks are stored BOTH in the album canonical location
AND mirrored into the playlist's tracks/ directory. Duplicates are acceptable
and expected. This is already implemented via playlistMirror.js.

USER'S MENTAL MODEL (filesystem analogy):
  "My Playlist" {
    playlistcover.png
    playlist.json
    Scissor Sisters album {
      album.json, cover.png
      Tracks { Track 2 { track.json, track.mp3 }, Track 3 { ... } }
    }
    LOONA album {
      album.json, cover.png
      Tracks { Stars { track.json, track.mp3 } }
    }
  }

CURRENT STATE: The actual on-disk structure uses flat trackId directories under
playlists/{pid}/tracks/{tid}/{quality}/ rather than nesting by album. The album
grouping the user describes is a LOGICAL grouping (metadata in playlist.json
and items.json), not a physical directory nesting. The current structure is
functionally equivalent but visually different from the user's mental model.
This is acceptable — the behavior matters, not the exact directory layout.

1.2  "YOUR LIBRARY" SIDEBAR RULES
----------------------------------
RULE A — PLAYLIST APPEARS when:
  • It has ≥1 downloaded track with a valid audio file on local disk.

RULE B — PLAYLIST IS REMOVED ONLY when:
  • ALL of its downloaded tracks have been deleted (zero local audio files).
  • NOT when a single track is deleted while others remain.

RULE C — PLAYING FROM PLAYLIST bumps it:
  • Playing any track from a playlist context moves that PLAYLIST (not the
    individual track's album) to the top of "Your Library" recency sort.

RULE D — NO DUPLICATE LISTINGS:
  • A playlist must never appear twice in "Your Library" under any circumstance.
  • After delete + re-play, the same playlist entry should be reused, not a
    second one created.

1.3  DELETION SCENARIOS — EXPECTED BEHAVIOR
--------------------------------------------

SCENARIO A: Single track delete (right-click → "Delete download" from Downloads)
  1. Delete the track's audio from the album canonical directory.
  2. Delete the track's mirror from ALL playlist directories that reference it.
  3. Remove track from db.tracks, db.albums[aid].trackIds, db.playlists[pid].trackIds.
  4. Update items.json to remove the trackId from downloads map.
  5. Remove track from renderer localStorage (downloadedTracks).
  6. IF playlist still has OTHER downloaded tracks → playlist STAYS in Your Library.
  7. IF playlist has ZERO remaining downloaded tracks → playlist REMOVED from Your Library.

SCENARIO B: Multi-select delete (from playlist/album page)
  Same as (A) for each selected track, then:
  8. After ALL deletions complete, check each affected playlist for remaining tracks.
  9. Same conditional removal logic as (A).

SCENARIO C: "Delete from library" (right-click on playlist/album card)
  For PLAYLIST:
  1. Delete ALL tracks belonging to this playlist (both mirrors AND album canonical
     files, but ONLY for tracks exclusively owned by this playlist).
  2. Delete the playlist directory from disk.
  3. Remove db.playlists entry.
  4. Remove playlist from renderer localStorage (savedPlaylists + downloadedTracks).
  5. Tracks that also belong to other contexts (other playlists, standalone album
     downloads) MUST survive — only delete tracks whose uuid is exclusively
     "playlist_{pid}_track_*".

  For ALBUM:
  1. Delete the album directory from disk.
  2. Rebuild DB from disk (scanAndRebuild) — playlist mirrors survive.
  3. Remove album from renderer localStorage.
  4. For each affected playlist: check if it still has downloaded tracks.
  5. Only remove playlist from Your Library if it has zero remaining tracks.

1.4  PLAYBACK BEHAVIOR
-----------------------
RULE P1 — PLAYER COVER ART:
  When playing a track from a playlist context:
  • Bottom-left player cover: shows PLAYLIST cover (not album cover).
  • Dashboard recents: shows PLAYLIST cover.
  • Inside the playlist track list: shows the track's ACTUAL album cover next
    to the track name.

RULE P2 — RECENCY BUMP:
  Playing from a playlist bumps the PLAYLIST to top of Your Library.
  It must NOT also bump the underlying album.

RULE P3 — PLAYLIST CONTEXT PRESERVATION:
  When the player downloads a track on-the-fly during playback from a playlist
  context, the download UUID must include the playlist prefix
  (playlist_{id}_track_{trackId}_{bitrate}) so that:
  • The playlist mirror is created.
  • The sidebar correctly groups it under the playlist.
  • The track is counted as belonging to the playlist for deletion logic.

1.5  RE-DOWNLOAD AFTER DELETE
------------------------------
RULE R1: If a user deletes a playlist, then navigates back and plays/downloads
  a track from it:
  • The track MUST be freshly downloaded (not played from stale cache or
    leftover files that should have been deleted).
  • The playlist should be re-added to Your Library as a SINGLE entry.
  • No "double" listing should appear.

RULE R2: If files were NOT actually deleted from disk (bug), playing the track
  should NOT create a second playlist entry. The system must detect the existing
  playlist and reuse it.


================================================================================
§2  ARCHITECTURE OVERVIEW (TWO-LAYER DATA MODEL)
================================================================================

There are TWO separate data stores that must stay in sync:

LAYER 1: MAIN PROCESS DB (source of truth for files on disk)
  File: main/downloadLibrary.js → db.json on disk
  Contains: db.tracks, db.albums, db.playlists
  Tracks actual audio files on disk.
  Rebuilt from disk via scanAndRebuild() (synchronous).

LAYER 2: RENDERER LOCALSTORAGE (UI state)
  File: renderer/localLibrary.js → localStorage "spotify.localLibrary.v1"
  Contains: savedTracks, downloadedTracks, savedAlbums, playlists, recentTracks
  Drives sidebar rendering and UI state.
  Modified by explicit API calls (addSavedPlaylist, removeDownloadedTrack, etc.)

CRITICAL INVARIANT: These two layers can get OUT OF SYNC. When they do, bugs
manifest as:
  • Playlist disappears from sidebar but files still exist on disk.
  • Playlist appears in sidebar but files are gone.
  • "Ghost" tracks that play instantly after supposed deletion.
  • Double listings when re-playing from a "deleted" playlist.

SYNC MECHANISM:
  Main → Renderer: dl.onEvent broadcasts, window.dl.listDownloads/listPlaylists
  Renderer → Main: window.dl.deleteFromDisk, window.dl.scanLibrary, etc.
  Renderer internal: "local-library:changed" CustomEvent triggers sidebar re-render.


================================================================================
§3  INTERACTION MATRIX
================================================================================

Each row is an action. Columns describe the expected outcome for each subsystem.

ACTION                          | Main DB              | LocalStorage           | Sidebar              | Player               | Files on Disk
--------------------------------|----------------------|------------------------|----------------------|----------------------|---------------------
Download track from playlist    | db.tracks += track   | downloadedTracks += t  | Playlist appears/    | —                    | Album canonical +
                                | db.playlists += pid  | playlists += pid       | stays at position    |                      | playlist mirror
                                | db.albums += album   |                        |                      |                      | created
--------------------------------|----------------------|------------------------|----------------------|----------------------|---------------------
Play track from playlist ctx    | —                    | recentTracks += entry  | Playlist bumps to    | Shows playlist cover | —
                                |                      | (with playlistId)      | top of recency sort  | in bottom-left       |
--------------------------------|----------------------|------------------------|----------------------|----------------------|---------------------
Play track (no playlist ctx)    | —                    | recentTracks += entry  | Album bumps to top   | Shows album cover    | —
                                |                      | (no playlistId)        | (if downloaded)      |                      |
--------------------------------|----------------------|------------------------|----------------------|----------------------|---------------------
Delete single track (Downloads) | db.tracks -= track   | downloadedTracks -= t  | IF remaining > 0:    | —                    | Album audio deleted
                                | mirror pruned        |                        |   no change          |                      | Mirror deleted
                                | items.json updated   |                        | IF remaining == 0:   |                      |
                                |                      |                        |   playlist removed   |                      |
--------------------------------|----------------------|------------------------|----------------------|----------------------|---------------------
Multi-select delete (playlist)  | Same as above ×N     | Same as above ×N       | Same conditional     | —                    | Same ×N
                                | (sequential)         | (AFTER scanLibrary)    | removal after ALL    |                      |
                                |                      |                        | deletions complete   |                      |
--------------------------------|----------------------|------------------------|----------------------|----------------------|---------------------
"Delete from library" playlist  | db.playlists -= pid  | downloadedTracks -= *  | Playlist removed     | —                    | Playlist dir deleted
                                | db.tracks -= owned   | playlists -= pid       |                      |                      | Album files deleted
                                | db.albums -= empty   |                        |                      |                      | (if exclusively owned)
--------------------------------|----------------------|------------------------|----------------------|----------------------|---------------------
"Delete from library" album     | db.albums -= aid     | downloadedTracks -= *  | Album removed.       | —                    | Album dir deleted
                                | scanAndRebuild()     | (only truly gone ones) | Playlists with       |                      | Playlist mirrors
                                |                      | savedAlbums -= aid     | surviving mirrors:   |                      | survive (hard-links)
                                |                      |                        | STAY                 |                      |
--------------------------------|----------------------|------------------------|----------------------|----------------------|---------------------
Re-play after playlist delete   | Track re-downloaded  | downloadedTracks += t  | Playlist re-appears  | Shows playlist cover | Fresh download
                                | with playlist uuid   | playlists += pid       | (single entry)       |                      | + mirror created
                                |                      |                        | NO double listing    |                      |


================================================================================
§4  IDENTIFIED BUGS (ACTIVE + LATENT)
================================================================================

BUG 1: PLAYLIST DELETION DOES NOT TRULY DELETE TRACK FILES
-----------------------------------------------------------
SEVERITY: Critical
LOCATION: main/downloadLibrary.js deletePlaylistFromDisk() lines 411-479
          renderer/contextMenu/menuBuilders.js lines 460-565

SYMPTOM: User deletes a playlist via "Delete from library". The playlist
disappears from the sidebar. But when the user navigates back to the playlist
page and plays a track, it plays INSTANTLY — proving the audio file was never
deleted from disk.

ROOT CAUSE:
  deletePlaylistFromDisk() at line 444-465 only deletes tracks whose uuid is
  EXCLUSIVELY "playlist_{pid}_track_*" across ALL quality slots. If a track's
  uuid is missing, or was re-downloaded with a bare "dl_*" uuid (e.g., via
  player on-the-fly download), the track is considered "shared" and preserved.

  Additionally, deletePlaylistFromDisk() deletes the playlist directory
  (mirrors) but does NOT delete the album canonical files. After
  scanAndRebuild(), the tracks are re-indexed from the album directories.
  The tracks still exist in db.tracks.

  The renderer then calls removeDownloadedTrack() for tracks matching the
  playlist uuid. But tracks that were re-downloaded with a different uuid
  (or tracks whose album canonical file survived) are NOT cleaned up.

USER IMPACT: "I sometimes delete the playlist, then go in and try to
redownload a song I had downloaded, only for it to apparently just play
instantly and making it obvious that it was never deleted."

CROSS-REFERENCE: This is the "half-fixed" issue the user mentions. The
previous patch fixed premature playlist removal from the sidebar, but
introduced (or failed to fix) the incomplete deletion problem.

BUG 2: DOUBLE PLAYLIST LISTING AFTER DELETE + RE-PLAY
------------------------------------------------------
SEVERITY: High
LOCATION: renderer/player/downloadPlayback.js lines 214-221
          renderer/sidebar/libraryLocalRenderer.js lines 402-490

SYMPTOM: After "deleting" a playlist (which doesn't truly delete files per
Bug 1), playing a track from the playlist page creates a SECOND listing of
the same playlist in "Your Library".

ROOT CAUSE:
  downloadPlayback.js line 216-217:
    if (hasPlaylistCtx && !lib.isPlaylistSaved?.(ctxId)) {
      lib.addSavedPlaylist?.({ id: ctxId, title: ..., cover: ... });
    }

  After deletion, lib.isPlaylistSaved() returns false (it was removed from
  localStorage). So addSavedPlaylist creates a NEW entry. Meanwhile, the
  sidebar renderer ALSO shows the playlist from downloadedPlaylistsById
  (source #2, from window.dl.listPlaylists()) because the main process still
  has the playlist's tracks indexed. This creates TWO sources for the same
  playlist:
    Source 1: savedPlaylists (newly re-added by downloadPlayback)
    Source 2: downloadedPlaylistsById (from main process, tracks still on disk)

  libraryLocalRenderer.js lines 437-463 adds playlists from
  downloadedPlaylistsById that are NOT already in playlistIdsInRest. But
  the savedPlaylists loop (lines 402-434) already added it. So it should
  be deduplicated... UNLESS the playlistId differs between the two sources
  (e.g., string vs number comparison issue) or the timing of the re-add
  causes a race.

  MORE LIKELY: The double listing occurs because:
  1. savedPlaylists has the entry (re-added by downloadPlayback).
  2. The "recently played playlists" loop (lines 466-490) ALSO adds it
     because playedAtByPlaylistId has an entry from the recent play, and
     playlistIdsInRest might not include it yet if the savedPlaylists loop
     skipped it (e.g., playlistHasDownloadedTracks returned false at that
     moment due to stale localStorage).

USER IMPACT: "The tracks that were 'deleted' I can play and it creates a
'double' listing of the same playlist under 'Your Library'."

BUG 3: PLAYLIST PREMATURELY REMOVED FROM SIDEBAR (PARTIALLY FIXED)
-------------------------------------------------------------------
SEVERITY: Medium (was Critical, partially addressed by previous patch)
LOCATION: renderer/contextMenu/menuBuilders.js reconcileSavedEntitiesAfterTrackDelete()
          renderer/library/trackMultiSelect.js reconcileSavedEntitiesByIds()

SYMPTOM: Deleting a single track from a playlist removes the entire playlist
from "Your Library" even when other tracks remain downloaded.

PREVIOUS FIX APPLIED:
  The previous patch added multi-source checking in getPlaylistDownloadedState():
  1. getOfflineTracklist (main process DB)
  2. listPlaylists (main process, independent count)
  3. listDownloads (fallback, checks uuid prefix)

  It also added resolveTrack checks before removeDownloadedTrack to avoid
  removing tracks that still have valid playlist mirrors on disk.

CURRENT STATE: The previous fix SHOULD prevent premature removal in most cases.
However, there are edge cases where it can still fail:

  EDGE CASE 3A: If scanLibrary hasn't completed before reconciliation runs,
  the main process data may be stale. The previous fix awaits scanLibrary
  before reconciliation, but the "local-library:changed" event from
  removeDownloadedTrack fires IMMEDIATELY, triggering a sidebar re-render
  that may use stale data.

  EDGE CASE 3B: For multi-select delete, removeDownloadedTrack is called
  AFTER scanLibrary (fixed in previous patch). But the sidebar re-render
  triggered by each removeDownloadedTrack call may still show flickering
  as tracks are removed one by one.

USER IMPACT: "Issue with the playlist listing under 'Your Library' being
prematurely removed is fixed, but now deleting from playlists no longer
truly deletes the songs from the playlist."

BUG 4: PLAYER COVER ART SHOWS ALBUM INSTEAD OF PLAYLIST
---------------------------------------------------------
SEVERITY: Medium
LOCATION: renderer/player/playbackSession.js playResolvedTrackUrl() lines 129-145

SYMPTOM: When playing a track from a playlist, the bottom-left player cover
shows the track's album cover instead of the playlist cover.

CURRENT STATE: This was PARTIALLY FIXED in a previous patch. Lines 139-144:
  const playCtx = state.playContext...
  const uiTrack = playCtxType === "playlist" && playCtxCover
    ? { ...track, cover: playCtxCover }
    : track;
  setNowPlayingUI(uiTrack);

This correctly overrides the cover for the player UI. However, the hydrated
track passed to lib.addRecentTrack (line 263) uses the ORIGINAL track object
(not uiTrack), so the recentTracks entry stores the album cover, not the
playlist cover. The recentTracksApi.js does store playlistCover separately
(line 53), but the dashboard recents renderer may not use it.

USER IMPACT: "For the 'recents' bit on the front landing/dashboard main page
AND for the album art in the bottom left corner, it shows the album art for
our playlist instead."

BUG 5: ITEMS.JSON trackIds NOT PRUNED ON SINGLE TRACK DELETE
-------------------------------------------------------------
SEVERITY: Medium
LOCATION: main/downloadLibrary.js removeDownloadForTrack() lines 289-309

SYMPTOM: When deleting a single track, the prunePlaylistMirror function
removes the track from items.json downloads map but does NOT remove the
trackId from the trackIds array.

ROOT CAUSE: Line 302-307:
  const prevTrackIds = Array.isArray(items.trackIds) ? items.trackIds : [];
  ...
  writeJsonAtomic(resolvedItemsPath, { trackIds: prevTrackIds, downloads: nextDownloads });

prevTrackIds is written back UNCHANGED. The trackId of the deleted track
remains in the trackIds array even though its download entry is removed.

This means getOfflineTracklist will still iterate over this trackId, find
no audio for it (db.tracks entry is gone), and mark it as __missing. This
doesn't cause a functional bug per se (the count of non-missing tracks is
still correct), but it leaves stale data in items.json and can cause
confusion in edge cases.

BUG 6: deletePlaylistFromDisk DOES NOT DELETE ALBUM CANONICAL FILES
-------------------------------------------------------------------
SEVERITY: Critical (root cause of Bug 1)
LOCATION: main/downloadLibrary.js deletePlaylistFromDisk() lines 411-479

DETAILED ROOT CAUSE:
  The function collects plTrackIds from db.playlists and items.json. For each
  track, it checks if the track is ONLY associated with this playlist by
  examining the uuid of each quality slot (lines 450-458).

  If onlyThisPlaylist is true, it calls removeDownloadForTrack() which deletes
  the album canonical file AND the playlist mirror.

  If onlyThisPlaylist is false (track is shared), it does NOT delete anything.
  The track survives in the album directory.

  Then line 468-469 deletes the playlist directory (mirrors only):
    fs.rmSync(path.join(playlistsRoot, pid), { recursive: true, force: true });

  After scanAndRebuild(), the surviving album canonical files are re-indexed.
  The tracks are back in db.tracks as if nothing happened.

  THE PROBLEM: The user expects "Delete from library" on a playlist to delete
  ALL tracks that were downloaded as part of that playlist, including their
  album canonical copies. The current code only deletes tracks that are
  EXCLUSIVELY owned by the playlist, preserving shared tracks.

  For tracks downloaded via the playlist (uuid = "playlist_{pid}_track_*"),
  the album canonical file and the playlist mirror are the SAME data (hard-link
  or copy). Deleting the mirror but not the canonical leaves the canonical
  intact. After scanAndRebuild, the track reappears.


================================================================================
§5  BUG REPRODUCTION FLOWS
================================================================================

REPRO 1: "Delete from library" doesn't truly delete (Bug 1 + Bug 6)
--------------------------------------------------------------------
PRECONDITION: Playlist "My Mix" with tracks A, B, C all downloaded.

  1. Right-click "My Mix" in Your Library sidebar.
  2. Click "Delete from library".
  3. OBSERVE: "My Mix" disappears from sidebar. ✓ (looks correct)
  4. Navigate to "My Mix" playlist page (via search or direct URL).
  5. Click play on Track A.
  6. OBSERVE: Track A plays INSTANTLY without downloading. ✗ (BUG)
     EXPECTED: Track A should require a fresh download.
  7. OBSERVE: "My Mix" reappears in sidebar. ✓ (correct re-add behavior)
  8. OBSERVE: A SECOND "My Mix" entry may appear in sidebar. ✗ (BUG 2)
     EXPECTED: Only one entry.

WHY IT HAPPENS:
  Step 2: deletePlaylistFromDisk deletes playlist dir but album canonical
          files survive. scanAndRebuild re-indexes them.
  Step 2: Renderer removes tracks from localStorage and playlist from
          savedPlaylists.
  Step 5: downloadPlayback.js finds the track via resolveTrack (album
          canonical still exists) and plays it instantly.
  Step 5: downloadPlayback.js re-saves the playlist via addSavedPlaylist
          (line 216-217) because isPlaylistSaved returns false.
  Step 7: Sidebar shows playlist from savedPlaylists (newly added).
  Step 8: Sidebar ALSO shows playlist from downloadedPlaylistsById (main
          process still has tracks). Deduplication may fail.

REPRO 2: Single track delete removes playlist from sidebar (Bug 3)
------------------------------------------------------------------
PRECONDITION: Playlist "My Mix" with tracks A, B, C all downloaded.

  1. Go to Downloads page.
  2. Right-click Track A → "Delete download".
  3. OBSERVE: "My Mix" disappears from sidebar. ✗ (BUG — partially fixed)
     EXPECTED: "My Mix" stays because B and C are still downloaded.

WHY IT HAPPENS (if still occurring):
  Step 2: deleteFromDisk removes Track A. scanLibrary rebuilds DB.
  Step 2: removeDownloadedTrack(A) fires "local-library:changed".
  Step 2: Sidebar re-renders. playlistIdsWithDownloadedTracks is built from:
          Source 1 (localStorage): Track A's uuid was the only one referencing
          this playlist in downloadedTracks. After removal, no tracks in
          localStorage reference this playlist.
          Source 2 (listPlaylists): SHOULD still show downloaded > 0 for B, C.
          If Source 2 works correctly, the playlist stays. The previous fix
          ensures Source 2 is checked.

REPRO 3: Multi-select delete from playlist page (Bug 3 variant)
---------------------------------------------------------------
PRECONDITION: Playlist "My Mix" with tracks A, B, C all downloaded.
              Viewing the "My Mix" playlist page.

  1. Long-press Track A to enter selection mode.
  2. Select Track A and Track B.
  3. Click "Delete 2 tracks from library".
  4. OBSERVE: "My Mix" should stay in sidebar (Track C remains).
  5. Select Track C.
  6. Click "Delete track from library".
  7. OBSERVE: "My Mix" should be removed from sidebar (zero tracks remain).

REPRO 4: Double listing after delete + re-play (Bug 2)
------------------------------------------------------
PRECONDITION: Playlist "My Mix" with Track A downloaded.

  1. Right-click "My Mix" → "Delete from library".
  2. OBSERVE: "My Mix" disappears from sidebar.
  3. Navigate to "My Mix" playlist page.
  4. Click play on Track A.
  5. OBSERVE: Track A plays instantly (Bug 1 — file not deleted).
  6. OBSERVE: TWO entries for "My Mix" appear in sidebar. ✗ (BUG)
     EXPECTED: One entry.

REPRO 5: Player shows wrong cover art (Bug 4)
----------------------------------------------
PRECONDITION: Playlist "My Mix" (with custom cover art) containing
              "LOONA - Stars" (which has its own album cover).

  1. Navigate to "My Mix" playlist page.
  2. Click play on "LOONA - Stars".
  3. OBSERVE bottom-left player: Should show "My Mix" playlist cover.
     ACTUAL: May show LOONA album cover (partially fixed).
  4. OBSERVE dashboard recents: Should show "My Mix" playlist cover.
     ACTUAL: May show LOONA album cover (recentTracks stores albumCover).
  5. OBSERVE track row inside playlist: Should show LOONA album cover
     next to the track name. ✓ (this is correct — entityRenderer uses
     track's own album art).


================================================================================
§6  CROSS-BUG DEPENDENCY MAP
================================================================================

Bug 1 (files not deleted) ←── CAUSED BY ──→ Bug 6 (deletePlaylistFromDisk
                                              doesn't delete album canonicals)
         │
         ├── ENABLES ──→ Bug 2 (double listing: files survive, re-play
         │                       triggers addSavedPlaylist, two sources)
         │
         └── MASKS ──→ Bug 3 (premature removal: if files WERE deleted,
                              the playlist SHOULD be removed; but since
                              they aren't, the "fix" for Bug 3 keeps the
                              playlist visible based on surviving files)

Bug 3 (premature removal) ←── PREVIOUS FIX ──→ Added multi-source checking
         │                                       in getPlaylistDownloadedState
         │
         └── ARTIFACT: The fix checks resolveTrack before removeDownloadedTrack.
             If the track still exists (Bug 1), it's NOT removed from
             localStorage. This means downloadedTracks retains stale entries
             that reference files the user thought were deleted.

Bug 4 (wrong cover) ←── PARTIALLY FIXED ──→ Player UI uses playCtx cover.
         │                                    But recentTracks may not.
         └── INDEPENDENT of Bugs 1-3.

DEPENDENCY CHAIN FOR FIXING:
  1. Fix Bug 6 FIRST (deletePlaylistFromDisk must delete album canonicals).
  2. Bug 1 is resolved by Bug 6 fix.
  3. Bug 2 is resolved by Bug 6 fix (no surviving files = no instant play
     = no addSavedPlaylist re-add = no double listing).
  4. Bug 3's previous fix remains valid and necessary.
  5. Bug 4 can be fixed independently.
  6. Bug 5 (items.json trackIds not pruned) is a cleanup, low priority.


================================================================================
§7  PREVIOUS PATCH ARTIFACTS & RISKS
================================================================================

7.1  WHAT THE PREVIOUS PATCH CHANGED
--------------------------------------
The previous patch addressed Bug 3 (premature playlist removal) by:

  A) Adding resolveTrack checks before removeDownloadedTrack in:
     - menuBuilders.js (single track delete, lines 305-316)
     - trackMultiSelect.js (multi-select delete, lines 420-432, 499-512)
     - notifications/menu.mjs (notification delete action, lines 348-359)

  B) Adding multi-source getPlaylistDownloadedState() that checks:
     1. getOfflineTracklist (main process DB)
     2. listPlaylists (independent count)
     3. listDownloads (uuid-based fallback)
     All three must agree the playlist is empty before removal.

  C) Ensuring scanLibrary is awaited BEFORE removeDownloadedTrack in
     multi-select paths (trackMultiSelect.js lines 415-417, 493-495).

  D) Adding the current route's entity to affected sets so reconciliation
     always checks the current page's playlist/album.

7.2  ARTIFACTS OF THE PREVIOUS PATCH
--------------------------------------
ARTIFACT 1: STALE LOCALSTORAGE ENTRIES
  Because resolveTrack returns true for tracks whose album canonical files
  survived deletion (Bug 1/6), removeDownloadedTrack is SKIPPED for those
  tracks. This means downloadedTracks in localStorage retains entries for
  tracks the user thought they deleted. These stale entries:
  - Make the sidebar show the playlist (correct if files exist, but user
    expects them gone).
  - Make the download cache (downloadPlayback.js) find stale fileUrls.
  - Prevent fresh downloads when re-playing.

ARTIFACT 2: OVER-PROTECTIVE RECONCILIATION
  The multi-source getPlaylistDownloadedState is designed to be conservative:
  it only removes a playlist if ALL sources agree it's empty. This is correct
  for preventing premature removal, but it also means that if Bug 6 is fixed
  (files actually deleted), the reconciliation will correctly remove the
  playlist. No conflict.

ARTIFACT 3: SIDEBAR RE-RENDER TIMING
  removeDownloadedTrack fires "local-library:changed" synchronously, which
  triggers a sidebar re-render. The re-render calls listPlaylists (async IPC).
  If multiple removeDownloadedTrack calls happen in sequence (multi-select),
  each triggers a re-render. The sidebar may flicker as tracks are removed
  one by one. This is cosmetic, not functional.

7.3  RISKS OF FIXING BUG 6 WITH PREVIOUS PATCH IN PLACE
---------------------------------------------------------
RISK 1: NONE for reconciliation logic.
  If Bug 6 is fixed (files truly deleted), then:
  - resolveTrack returns false → removeDownloadedTrack proceeds → localStorage
    is cleaned up.
  - getPlaylistDownloadedState returns remaining=0, confidentEmpty=true →
    removeSavedPlaylist proceeds.
  - Sidebar re-renders without the playlist.
  This is the CORRECT behavior. The previous patch's conservative checks
  become pass-through when files are actually gone.

RISK 2: NONE for single-track delete.
  If a single track is deleted and its album canonical + mirror are both gone:
  - resolveTrack returns false → removeDownloadedTrack proceeds.
  - Other tracks in the playlist still have their files → playlist stays.
  This is correct.

RISK 3: MINOR for "Delete from library" on album.
  deleteAlbumFromDisk deletes the album directory, then scanAndRebuild.
  Playlist mirrors (hard-links) survive because they're in the playlists/
  directory, not the albums/ directory. After scan, the mirrors are re-indexed.
  The previous patch's resolveTrack check correctly preserves these tracks
  in localStorage. No conflict.

CONCLUSION: Fixing Bug 6 is SAFE with the previous patch in place. The
previous patch's conservative checks will correctly pass through when files
are truly deleted, and correctly preserve when files survive (e.g., shared
tracks, playlist mirrors after album deletion).


================================================================================
§8  FILE-LEVEL CODE MAP
================================================================================

MAIN PROCESS (Node.js):
  main/downloadLibrary.js
    - createDownloadLibrary()           — factory for all download library ops
    - removeDownloadForTrack()          — delete single track (lines 242-360)
    - deletePlaylistFromDisk()          — delete entire playlist (lines 411-479)
    - deleteAlbumFromDisk()             — delete entire album (lines 397-409)
    - ensurePlaylistMetadata()          — save playlist metadata (lines 362-395)
    - ensurePlaylistTrackMirror()       — create playlist mirror (lines 493-537)
    - ensureTrackStoredFromStaging()    — move track from staging (lines 199-220)

  main/downloadLibrary/dbIndex.js
    - listDownloadedPlaylists()         — list playlists with download counts (lines 163-244)
    - resolveTrack()                    — find track audio on disk
    - listDownloadedTracks()            — list all downloaded tracks

  main/downloadLibrary/playlistMirror.js
    - ensurePlaylistTrackMirror()       — hard-link/copy audio to playlist dir (lines 4-94)

  main/downloadLibrary/offlineTracklist.js
    - createOfflineTracklistResolver()  — resolve playlist/album track lists with __missing flags

  main/downloadLibrary/scanner.js
    - scanAndRebuild()                  — rebuild entire DB from disk (synchronous)

  main/ipc/downloads/downloadUrlHandler.js
    - Playlist download handler         — iterates tracks, creates mirrors (lines 115-207)

RENDERER (Browser):
  renderer/localLibrary.js
    - createLocalLibrary()              — localStorage state manager (lines 18-85)

  renderer/localLibrary/savedTracksApi.js
    - upsertDownloadedTrack()           — add/update downloaded track in localStorage (lines 92-135)
    - removeDownloadedTrack()           — remove downloaded track from localStorage (lines 137-165)

  renderer/localLibrary/savedCollectionsApi.js
    - addSavedPlaylist()                — add playlist to localStorage (lines 96-121)
    - removeSavedPlaylist()             — remove playlist from localStorage (lines 123-131)

  renderer/localLibrary/recentTracksApi.js
    - addRecentTrack()                  — record recent play with playlist context (lines 4-65)

  renderer/sidebar/libraryLocalRenderer.js
    - renderLibraryLocal()              — build sidebar from localStorage + main process (lines 9-562)
    - playlistIdsWithDownloadedTracks   — set built from uuid parsing + listPlaylists (lines 94-103)
    - playlistHasDownloadedTracks()     — check if playlist should be shown (lines 99-103)

  renderer/player/playbackSession.js
    - playResolvedTrackUrl()            — play track, set cover, record recent (lines 129-266)
    - setNowPlayingUI()                 — update player UI with track info (lines 60-74)

  renderer/player/downloadPlayback.js
    - attemptDownloadAndPlay()          — resolve/download track for playback (lines 27-237)
    - UUID generation                   — playlist/album/bare context (lines 158-167)
    - Re-save playlist on play          — addSavedPlaylist if not saved (lines 214-221)

  renderer/contextMenu/menuBuilders.js
    - "Delete download" handler         — single track delete (lines 261-330)
    - "Delete from library" handler     — entity delete (lines 460-565)
    - reconcileSavedEntitiesAfterTrackDelete() — check remaining tracks (lines 103-124)
    - getPlaylistDownloadedState()      — multi-source remaining check (lines 37-96)

  renderer/library/trackMultiSelect.js
    - Multi-select delete handler       — batch delete (lines 376-548)
    - reconcileSavedEntitiesByIds()     — check remaining for multiple entities (lines 68-97)
    - getPlaylistDownloadedState()      — same multi-source check (lines 98-161)

  renderer/notifications/menu.mjs
    - "delete" action handler           — delete from notifications (lines 308-367)
    - reconcileSavedEntitiesAfterTrackDelete() — same pattern (lines 126-145)
    - getPlaylistDownloadedState()      — same multi-source check (lines 66-125)


================================================================================
END OF SPECIFICATION
================================================================================
